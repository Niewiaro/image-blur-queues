{% extends 'base.html' %}

{% block title %}
  Image Processing
{% endblock %}

{% block header %}
  Upload & Blur
{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card mb-4 shadow-sm">
        <div class="card-body text-center">
          {% if g.user %}
            <div class="alert alert-success d-inline-block">
              <i class="bi bi-shield-check"></i> You are logged in. Mode: <strong>HIGH PRIORITY</strong>
            </div>
          {% else %}
            <div class="alert alert-warning d-inline-block">
              <i class="bi bi-person"></i> You are a guest. Mode: <strong>STANDARD (Low Priority)</strong>
            </div>
          {% endif %}

          <form id="upload-form" class="mt-3 mx-auto" style="background: none; border: none; padding: 0;">
            <div class="mb-3">
              <label for="file" class="form-label">Choose an image to blur</label>
              <input class="form-control form-control-lg" type="file" name="file" id="file" required />
            </div>
            <button type="submit" class="btn btn-primary btn-lg w-100"><i class="bi bi-magic"></i> Upload & Blur</button>
          </form>
        </div>
      </div>

      <div id="status-area" class="card shadow-sm" style="display: none;">
        <div class="card-header bg-secondary text-white">Processing Result</div>
        <div class="card-body text-center">
          <h5 class="card-title">Status: <span id="task-status" class="badge bg-warning text-dark">Waiting...</span></h5>
          <p class="card-text text-muted">
            Task ID: <span id="task-id" class="font-monospace"></span>
          </p>
          <p class="card-text">
            Queue: <span id="queue-name" class="fw-bold text-info"></span>
          </p>

          <div id="loader" class="my-3 text-info">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Processing...</div>
          </div>

          <img id="result-image" src="" class="img-fluid mt-3" style="display: none; border: 2px solid #fff;" />
        </div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('upload-form').onsubmit = async (e) => {
      e.preventDefault()
      const formData = new FormData(e.target)
      const statusArea = document.getElementById('status-area')
    
      statusArea.style.display = 'block'
      document.getElementById('task-status').innerText = 'Sending...'
      document.getElementById('task-status').className = 'badge bg-secondary' // Reset koloru
      document.getElementById('result-image').style.display = 'none'
      document.getElementById('loader').style.display = 'block'
    
      // 1. WysyÅ‚ka pliku
      const response = await fetch("{{ url_for('image.upload_file') }}", {
        method: 'POST',
        body: formData
      })
      const data = await response.json()
    
      document.getElementById('task-id').innerText = data.task_id
      document.getElementById('queue-name').innerText = data.queue
    
      // 2. Polling
      checkStatus(data.task_id)
    }
    
    async function checkStatus(taskId) {
      const response = await fetch(`/image/status/${taskId}`)
      const data = await response.json()
    
      const statusBadge = document.getElementById('task-status')
      statusBadge.innerText = data.status
    
      if (data.status === 'SUCCESS') {
        statusBadge.className = 'badge bg-success'
        document.getElementById('loader').style.display = 'none'
    
        const img = document.getElementById('result-image')
        img.src = data.image_url
        img.style.display = 'block'
      } else if (data.status === 'FAILURE') {
        statusBadge.className = 'badge bg-danger'
        document.getElementById('loader').innerText = 'Error: ' + data.error
      } else {
        // PENDING / STARTED
        statusBadge.className = 'badge bg-warning text-dark'
        setTimeout(() => checkStatus(taskId), 1000)
      }
    }
  </script>
{% endblock %}
